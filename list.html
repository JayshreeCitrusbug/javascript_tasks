<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="/style.css" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <title>User Listing</title>
</head>
<body>
    <h1> Listing page</h1>
    <small id="no-data"></small>
    <div class="list-container">
    <table class="table table-striped">
        <thead>
            <tr>
                <th></th>
                <th>#</th>
                <th><b>First Name</b></th>
                <th><b>Last Name</b></th>
                <th><b>Email</b></th>
                <th><b>Date of Birth</b></th>
                <th><b>Gender</b></th>
                <th><b>Hobby</b></th>
                <th><b>Technology</b></th>
                <th><b>View</b></th>
              </tr>
        </thead>

        <tbody id="tbody">
          
        </tbody>
      </table>
    </div>

      
    <div id="modalPopUp" class="w3-modal">
        <div class="w3-modal-content">
        <div class="w3-container">
            <span onclick="document.getElementById('modalPopUp').style.display='none'" class="w3-button w3-display-topright">&times;</span>
            <br>
            Are you sure you want to delete selected data.<br>
            This action can not be undone.
            <button type="button" class="btn btn-secondary" id="noBtn" onclick="document.getElementById('modalPopUp').style.display='none'">NO</button>
            <button type="button" class="btn btn-danger" id="yesBtn" onclick="deleteSelecteData()">Yes</button>
        </div>
        </div>
    </div>
     
    <div class="buttons">
        <button type="button" class="btn btn-warning" id="editBtn" onclick="editRecord()">Edit</button>
        <button type="button" class="btn btn-danger" id="deleteBtn" onclick="deleteRecord()">Delete</button>
        <button type="button" class="btn btn-primary" style="margin-left: 21%; margin-top: initial; padding-left: 50px; padding-right: 50px; height:50px; font-size: 18px;" onclick="window.location.href = 'http://127.0.0.1:5500/index-1.html';">Back</button>
    </div>
    <script>
        function showPrefillData(){
            console.log("localStorage", localStorage)
            var getSelectedData = [];
            // var retrievedObject = JSON.parse(localStorage);
            var tbody = document.getElementById('tbody');
          
            for (var i = 1; i <= localStorage.length; i++) {
                var tr = "<tr>";
                tr += `<td></td>
                        <td> <input class="form-check-input-data" type="checkbox" value="" id="${i}"></td>
                        <td> ${JSON.parse(localStorage[i]).fname} </td> 
                        <td> ${JSON.parse(localStorage[i]).lname} </td> 
                        <td> ${JSON.parse(localStorage[i]).email}</td> 
                        <td> ${JSON.parse(localStorage[i]).dob}</td>
                        <td> ${JSON.parse(localStorage[i]).gender}</td>
                        <td> ${JSON.parse(localStorage[i]).hobby}</td>
                        <td> ${JSON.parse(localStorage[i]).technology}</td>
                        <td> <button type="button" class="btn btn-primary" onclick="viewRow(${i})">View</button> </td>
            </tr>`;
                
                tbody.innerHTML += tr;
            }
        }

        function viewRow(rowId) {
            // Perform any action when the button is clicked, e.g., open a modal to edit the row data.
            console.log("Viewing row with ID:", rowId);
            url = `http://127.0.0.1:5500/view.html?data=${(rowId)}`;
    
            document.location.href = url;
            // window.location.assign(`http://127.0.0.1:5500/view.html?data=${localStorage[rowId]}`);
            // console.log("local storage.",localStorage[rowId])
            return true
        }

        function deleteRecord(){
            var getSelectedData = document.querySelectorAll('input[type="checkbox"]:checked');   
            if(getSelectedData.length==0){
                alert("Please select data for deletion");
            }
            else{
                document.getElementById('modalPopUp').style.display='block';
            }
            return getSelectedData
        }

        function deleteSelecteData(){
            var dataDeleted = [];
            var inputElements = document.getElementsByClassName('form-check-input-data'); 
            for(var i=0; inputElements[i]; ++i){
                if(inputElements[i].checked){
                    dataDeleted.push(inputElements[i].id);
                }
            }
            
            console.log(dataDeleted)
            var arraryList = Object.entries(localStorage);
            console.log("when storage", arraryList.length);
            console.log("...................");
            console.log(arraryList)
            const finalDataDeleteIndex = [];
            const copiedArraryList = JSON.parse(JSON.stringify(arraryList));
            
            //for (let i = dataDeleted.length - 1; i >= 0; i--)
            //arraryList.forEach((item, index)=> {
            //    if(dataDeleted.includes(item[0])){
            //        arraryList.splice(item[0], 1);
            //    }
            //})

            copiedArraryList.forEach((item, index) =>{
                console.log("item", item, item[0], typeof(item[0]), "index", index, dataDeleted.includes(item[0]))
                console.log("!!!!!!!!!!!!!!!!!!!!!")
                if(dataDeleted.includes(item[0])){
                    finalDataDeleteIndex.push(index)
                    //arraryList.splice(index, 1);
                    console.log("in foreach loop of splice", arraryList, arraryList.length)
                    localStorage.removeItem(item[0]);
                }
            })
            
            for (let i = finalDataDeleteIndex.length - 1; i >= 0; i--){
                arraryList.splice(finalDataDeleteIndex[i], 1);
            }
            console.log("After iteration", arraryList)


            // var arraryList = Object.values(localStorage);

            arraryList = arraryList.filter(Boolean); // Remove any undefined/null elements
            console.log("arraryList on checking filter boolean", arraryList)

            //arraryList = arraryList.map((item, index) => {
             //   return { index: index, value: JSON.parse(item) };
            //});
            console.log("arraryList on map", arraryList)
            
            // Step 3: Save the reindexed array back into localStorage
            localStorage.clear();
            arraryList.forEach((item, index) => {
                console.log("item", item, "index", index, index+1)
                console.log("index", index)
                localStorage.setItem(index+1, (item[1]));
            });

            document.getElementById('modalPopUp').style.display='none';
            window.location.reload();
            
            // arraryList.forEach((item, index) =>{
            //         localStorage.setItem(index+1, JSON.stringify(item));
            //     })
                // document.getElementById('modalPopUp').style.display='none';
                // window.location.reload();

        }
        
        function editRecord(){
            var getSelectedDataForEdit = document.querySelectorAll('input[type="checkbox"]:checked');   
            console.log("getSelectedDataForEdit")
            console.log(getSelectedDataForEdit)
            if(getSelectedDataForEdit.length==0){
                alert("Please select any data for edit record");
            }
            else{
                var editData = [];
                var inputElements = document.getElementsByClassName('form-check-input-data'); 
                for(var i=0; inputElements[i]; ++i){
                    if(inputElements[i].checked){
                        editData.push(inputElements[i].id);
                    }
                }
                console.log("editData", editData)
                //console.log("Viewing row with ID:", rowId);
                url = `http://127.0.0.1:5500/update.html?data=${(editData)}`;
        
                document.location.href = url;

            }
        }
        


        showPrefillData()
        

    </script>
</body>
</html>